<!DOCTYPE html>
<html lang="ja">
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Shopping List</title>
</head>
<body>
    <div class="page_title"><h1>Edit SHOPPING LIST</h1></div>
    <br>
    <table class="link">
        <tr>
            <td><h2><%= link_to "Shopping Index","/shopping/index" %></h2></td>
        </tr>
        <tr>
            <td><h2><%= link_to "買い物リストを確認する",shopping_show_shopping_list_path(start_date:params[:start_date],end_date:params[:end_date]) %></h2></td>
        </tr>
    </table>
    <br>
    <h2><%= params[:start_date]%>~<%=params[:end_date]%></h2>
    <br>
    <table border="1" class="edit_shopping_list">
        <tr>
            <th>削除</th>
            <th>食材名</th>
            <th>数</th>
            <th>変更</th>
        </tr>
        <%shopping_list().each do |item|%>
            <tr>
                <td>
                    <%= form_with url:"/shopping/#{item.id}/delete",method: :delete do |f|%>
                        <%= f.hidden_field :start_date, value: params[:start_date] %>
                        <%= f.hidden_field :end_date, value: params[:end_date] %>
                        <%= f.submit "削除", data: { confirm: "削除してよろしいですか?"}%>
                    <%end%>
                </td>
                <td>
                    <%= Food.find_by(id:item.food_id)[:name]%>
                </td>
                <% if item.unit != "none"%>
                    <%= form_with url:"/shopping/update_shopping_list" do |f2| %>
                        <td>
                            <%= f2.hidden_field :id, value: item.id %>
                            <%= f2.hidden_field :start_date, value: params[:start_date] %>
                            <%= f2.hidden_field :end_date, value: params[:end_date] %>
                            <%= f2.text_field :quantity,value:item.quantity,size:10%><%= item.unit%>
                        </td>
                        <td>
                            <%= f2.submit "変更"%>
                        </td>
                    <%end%>
                <%end%>
            </tr>
        <%end%>
    </table>
    <br>
    <h3>追加する</h3>
    <table class="add_shopping">
        <%=form_with url:"/shopping/add_shopping", id:"add_shopping" do |f3| %>
            <%= f3.hidden_field :start_date, value: params[:start_date] %>
            <%= f3.hidden_field :end_date, value: params[:end_date] %>
            <td>
                <div class="form-input-select"> 
                    <%= f3.select :category, @category_parent_array, {}, {class: 'listing-select-wrapper__box--select', id:'parent_category'}%>
                </div>
            </td>
            <td>
                <div class ="listing-product-detail__category"></div>
            </td>
            <td>
                <%= f3.text_field :amount %>
            </td>
            <td>
                <%= f3.submit "追加"%>
            </td>
        <%end%>
    </table>
    <br>
    <br>
</body>

<script>
$ (function(){
  
  //子カテゴリー,セレクトボックスの選択
  function appendOption(child){
    //value="${category.name}"については、ストロングパラメーターでの値の取り方によってcategory.idの場合もあると思います。
    var html = `<tr><td>
                  <input type="radio" value="${child.id}" name="food_id" class="listing-select-wrapper__box--select" id="child_category" form="add_shopping">${child.name}
                </td></tr>`;
    return html;
  }
  
  //子カテゴリーのビュー作成
  function appendChildrenBox(insertHTML){
    var childSelectHtml = '';
    childSelectHtml = `<div class='listing-select-wrapper__added' id= 'children_wrapper'>
                        <div class='listing-select-wrapper__box'>
                        <table>
                            ${insertHTML}
                        </table>
                        </div>
                      </div>`;
    $('.listing-product-detail__category').append(childSelectHtml);
  }

  //親カテゴリーが選択された時の処理（子カテゴリーの表示）
  $("#parent_category").on('change', function(){
    //選択された親カテゴリーの値を取得
    var parentCategory = document.getElementById('parent_category').value;
    //選択された親カテゴリーが"---"（初期設定）のままだとfalse、変わっているとtrue
    if (parentCategory != "---"){
      $.ajax({
        url: '/recipes/show_food_choices_by_category/get_category_children',
        type: 'GET',
        //コントローラーに飛ばす値です。
        data: { category: parentCategory },
        dataType: 'json'
      })
      .done(function(children){
        //まず、既に表示されている子カテゴリーを削除
        $('#children_wrapper').remove();
        //insertHTMLという変数にカテゴリーのセレクトボックスの選択肢を入れる。（一番最初の段落で設けた変数）
        var insertHTML = '';
        children.forEach(function(child){
          insertHTML += appendOption(child);
        });
        //2段落目で設定した子カテゴリーのビューの呼び出し
        appendChildrenBox(insertHTML);
      })
      .fail(function(){
        alert('カテゴリー取得に失敗しました');
      })
    }else{
      $('#children_wrapper').remove();
    }
  });
});
</script>
</html>