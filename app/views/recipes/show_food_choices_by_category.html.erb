<!DOCTYPE html>
<html lang="ja">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<br>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>材料登録2</title>
</head>
<body>
<div class="page_title">
    <h1>材料の登録2</h1>
</div>
<h2>登録されていない材料</h2>
<table class="ingredient_2" border="1">
  <tr>
      <th>材料</th>
      <th>分量</th>
  </tr>
  <%@ingredients.each do |m|%>
      <% @foodlist = Food.where("name LIKE ? OR keyword LIKE ?","%#{m.foodname}%","%#{m.foodname}%")%>
      <%if @foodlist.empty?%>
          <tr>
              <td><%= m.foodname%></td>
              <td><%= m.amount%></td>
          </tr>
      <%end%>
  <%end%>
</table>
<h3>登録された買い物リスト</h3>
  <table class="ingredient_2" border="1">
    <tr>
      <th>買い物リスト</th>
    </tr>
    <% materials().each do |m|%>
      <tr>
        <td>
            <%= Food.find_by(id:m.food_id).name %>
        </td>
        <td>
            <%unless m.quantity === nil%>
              <%= m.quantity.ceil%><%= m.unit%>
            <%end%>
        </td>
      </tr>
    <%end%>
  </table>
<br>
<p>材料リストに材料を登録しますか？</p>
  <table class="add_material_form">
    <tr>
        <th></th>
        <th>分量</th>
        <th></th>
    </tr>
    <tr>
    <%=form_with url:"/recipes/create_manual_materials" do |f| %>
        <%= f.hidden_field :recipe_id, value: params[:id] %>
        <td>
            <div class="form-input-select"> 
                <%= f.select :category, @category_parent_array, {}, {class: 'listing-select-wrapper__box--select', id:'parent_category'}%>
            </div>
            <div class ="listing-product-detail__category"></div>
        </td>
        <td>
            <%= f.text_field :amount %>
        </td>
        <td>
            <%= f.submit "登録"%>
        </td>
    <%end%>
    </tr>
  </table>
<br>
<br>
<h4><%= link_to "登録内容を確認する", "/recipes/#{params[:id]}"%></h4>
<br>
</body>


<script>
$ (function(){
  
  //子カテゴリー,セレクトボックスの選択
  function appendOption(child){
    //value="${category.name}"については、ストロングパラメーターでの値の取り方によってcategory.idの場合もあると思います。
    var html = `<tr><td>
                  <input type="radio" value="${child.id}" name="food_id" class="listing-select-wrapper__box--select" id="child_category">${child.name}
                </td></tr>`;
    return html;
  }
  
  //子カテゴリーのビュー作成
  function appendChildrenBox(insertHTML){
    var childSelectHtml = '';
    childSelectHtml = `<div class='listing-select-wrapper__added' id= 'children_wrapper'>
                        <div class='listing-select-wrapper__box'>
                        <table>
                            ${insertHTML}
                        </table>
                        </div>
                      </div>`;
    $('.listing-product-detail__category').append(childSelectHtml);
  }

  //親カテゴリーが選択された時の処理（子カテゴリーの表示）
  $("#parent_category").on('change', function(){
    //選択された親カテゴリーの値を取得
    var parentCategory = document.getElementById('parent_category').value;
    //選択された親カテゴリーが"---"（初期設定）のままだとfalse、変わっているとtrue
    if (parentCategory != "---"){
      $.ajax({
        url: '/recipes/show_food_choices_by_category/get_category_children',
        type: 'GET',
        //コントローラーに飛ばす値です。
        data: { category: parentCategory },
        dataType: 'json'
      })
      .done(function(children){
        //まず、既に表示されている子カテゴリーを削除
        $('#children_wrapper').remove();
        //insertHTMLという変数にカテゴリーのセレクトボックスの選択肢を入れる。（一番最初の段落で設けた変数）
        var insertHTML = '';
        children.forEach(function(child){
          insertHTML += appendOption(child);
        });
        //2段落目で設定した子カテゴリーのビューの呼び出し
        appendChildrenBox(insertHTML);
      })
      .fail(function(){
        alert('カテゴリー取得に失敗しました');
      })
    }else{
      $('#children_wrapper').remove();
    }
  });
});
</script>
</html>