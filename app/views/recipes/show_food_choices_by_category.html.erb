<!DOCTYPE html>
<html lang="ja">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<%= javascript_pack_tag 'application','data-turbolinks-track': 'reload'%>
<br>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>材料登録2</title>
</head>
<body>
<div class="overlay">
  <div class="close_btn"><%= link_to("×","/recipes/index")%></div>
  <div class="new_ingredients_table">
      <h1 class="title_newrecipe">材料の登録2</h1>
  <!-- 材料リストの追加 -->
    <div class="add_material">
      <p>カテゴリーから食材を選択し、<br>分量を入力して登録してください。</p>
        <%=form_with url:"/recipes/create_manual_materials", id:"add_form" ,class:"add_form" do |f| %>
          <table class="add_material_tablea">
            <tr>
              <td><%= f.select :category, @category_parent_array, {}, {class: 'listing-select-wrapper__box--select', id:'parent_category'}%></td>
            </tr>
            <tr>
              <td><div class ="listing-product-detail__category"></div></td>
            </tr>
            <tr>
              <td><%= f.label "分量"%>　<%= f.text_field :amount, size:30 %></td>
            </tr>
          </table>
          <%= f.hidden_field :kind, value: "new_material" %>
          <%= f.hidden_field :recipe_id, value: params[:id] %>
          <%= f.submit "登録" , class:"add_material_btn"%>
        <%end%>
    </div>
      <!-- 材料登録されていない分量のリスト-->
        <div class="unregistered_materials_list">
          <div class="material_title">登録されていない材料</div>
            <table class="ingredients_list">
              <tr>
                  <th>材料</th>
                  <th>分量</th>
              </tr>
              <%@ingredients.each do |m|%>
                <% @foodlist = Food.where("name LIKE ? OR keyword LIKE ?","%#{m.foodname}%","%#{m.foodname}%")%>
                  <%if @foodlist.empty?%>
                    <tr>
                      <td><%= m.foodname%></td>
                      <td><%= m.amount%></td>
                    </tr>
                  <%end%>
            <%end%>
            </table>
        </div>
      <!-- 登録した材料リスト 
        <div class="registered_materials_list">
          <div class="material_title">材料リスト</div>
            <table class="materials_list">
              <tr>
                <th>材料</th>
                <th>数</th>
              </tr>
              <% materials().each do |m|%>
              <tr>
                <td>
                  <%= Food.find_by(id:m.food_id)[:name]%>
                </td>
                <td>
                <%unless m.quantity === nil%>
                  <%= m.quantity.floor(1)%><%=Food.find_by(id:m.food_id)[:unit]%>
                <%end%>
                </td>
              </tr>
              <%end%>
            </table>
        </div>-->
    
  <br>
  <div class="recipe_show_link"><%= link_to "登録内容を確認する", "/recipes/#{params[:id]}"%></div>
  <br>
</div>
</body>

<!--
<script>
  $ (function(){
    
    //子カテゴリー,セレクトボックスの選択
    function appendOption(child){
      //value="${category.name}"については、ストロングパラメーターでの値の取り方によってcategory.idの場合もあると思います。
      var html = `<tr><td>
                    <input type="radio" value="${child.id}" name="food_id" class="listing-select-wrapper__box--select" id="child_category" form="create_manual_materials">${child.name}
                  </td></tr>`;
      return html;
    }
    
    //子カテゴリーのビュー作成
    function appendChildrenBox(insertHTML){
      var childSelectHtml = '';
      childSelectHtml = `<div class='listing-select-wrapper__added' id= 'children_wrapper'>
                          <div class='listing-select-wrapper__box'>
                          <table>
                              ${insertHTML}
                          </table>
                          </div>
                        </div>`;
      $('.listing-product-detail__category').append(childSelectHtml);
    }

    //親カテゴリーが選択された時の処理（子カテゴリーの表示）
    $("#parent_category").on('change', function(){
      //選択された親カテゴリーの値を取得
      var parentCategory = document.getElementById('parent_category').value;
      //選択された親カテゴリーが"---"（初期設定）のままだとfalse、変わっているとtrue
      if (parentCategory != "---"){
        $.ajax({
          url: '/recipes/show_food_choices_by_category/get_category_children',
          type: 'GET',
          //コントローラーに飛ばす値です。
          data: { category: parentCategory },
          dataType: 'json'
        })
        .done(function(children){
          //まず、既に表示されている子カテゴリーを削除
          $('#children_wrapper').remove();
          //insertHTMLという変数にカテゴリーのセレクトボックスの選択肢を入れる。（一番最初の段落で設けた変数）
          var insertHTML = '';
          children.forEach(function(child){
            insertHTML += appendOption(child);
          });
          //2段落目で設定した子カテゴリーのビューの呼び出し
          appendChildrenBox(insertHTML);
        })
        .fail(function(){
          alert('カテゴリー取得に失敗しました');
        })
      }else{
        $('#children_wrapper').remove();
      }
    });
  });
</script>
-->
</html>